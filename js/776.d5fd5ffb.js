"use strict";(self["webpackChunkbookkay"]=self["webpackChunkbookkay"]||[]).push([[776],{2776:(e,t,r)=>{r.r(t),r.d(t,{default:()=>O});r(246),r(7280),r(5363);var o=r(3673),i=r(2323);const s={class:"col"},a=(0,o._)("div",{class:"row q-ml-lg"},[(0,o._)("h2",{class:"q-mb-sm"},"Manuscript Configs")],-1),n={class:"row-12 q-ma-lg"},l={class:"row-12 q-mx-lg"},c={class:"row-12 q-ma-md"},p={class:"q-ml-sm"},d={class:"q-ml-sm"},h=(0,o._)("span",{class:"q-ml-sm"},"Are you sure you want publish? The contents of the published book cannot be altered or deleted after it had been published.",-1);function u(e,t,r,u,g,m){const f=(0,o.up)("q-separator"),_=(0,o.up)("q-input"),w=(0,o.up)("file-uploader"),y=(0,o.up)("q-btn"),b=(0,o.up)("q-tree"),v=(0,o.up)("q-spinner-hourglass"),k=(0,o.up)("q-card-section"),$=(0,o.up)("q-card-actions"),P=(0,o.up)("q-card"),C=(0,o.up)("q-dialog"),q=(0,o.up)("q-page"),U=(0,o.Q2)("close-popup");return(0,o.wg)(),(0,o.j4)(q,{class:"flex"},{default:(0,o.w5)((()=>[(0,o._)("div",s,[a,(0,o.Wm)(f,{inset:""}),(0,o._)("div",n,[(0,o.Wm)(_,{ref:"titleInput",modelValue:g.title,"onUpdate:modelValue":t[0]||(t[0]=e=>g.title=e),label:"Title:","label-color":"primary",style:{"font-size":"1rem"},filled:"",rules:[e=>null!==e&&""!==e||"Please type the title",e=>e.length<=100||"Title must be smaller than 100"],onBlur:t[1]||(t[1]=e=>m.editTitle(!0))},null,8,["modelValue","rules"])]),(0,o._)("div",l,[(0,o.Wm)(_,{ref:"descriptionInput",modelValue:g.description,"onUpdate:modelValue":t[2]||(t[2]=e=>g.description=e),label:"Description:","label-color":"primary",style:{"font-size":"1rem"},filled:"",rules:[!0],autogrow:"",onBlur:t[3]||(t[3]=e=>m.editDescription(!0))},null,8,["modelValue"])]),e.$store.getters["write/manuscriptProperty"]("front_cover")?((0,o.wg)(),(0,o.j4)(y,{key:1,outline:"",color:"positive",class:"q-ma-lg",label:"Front Cover",icon:"check_circle",onClick:t[4]||(t[4]=e=>{g.clear_cover=!0,g.coverToBeCleared="front_cover"})})):((0,o.wg)(),(0,o.j4)(w,{key:0,label:"Front Cover",class:"q-ma-lg",onUpload:m.handleUpload},null,8,["onUpload"])),e.$store.getters["write/manuscriptProperty"]("back_cover")?((0,o.wg)(),(0,o.j4)(y,{key:3,outline:"",color:"positive",class:"q-ma-lg",label:"Back Cover",icon:"check_circle",onClick:t[5]||(t[5]=e=>{g.clear_cover=!0,g.coverToBeCleared="back_cover"})})):((0,o.wg)(),(0,o.j4)(w,{key:2,label:"Back Cover",class:"q-ma-lg",onUpload:m.handleUpload},null,8,["onUpload"])),(0,o._)("div",c,[(0,o.Wm)(b,{ref:"optionsTree",class:"col-12 col-sm-6",nodes:g.options,"node-key":"body","tick-strategy":"strict",ticked:g.ticked,"onUpdate:ticked":[t[6]||(t[6]=e=>g.ticked=e),m.handleTicked]},null,8,["nodes","ticked","onUpdate:ticked"])]),(0,o._)("div",null,[(0,o.Wm)(y,{color:"primary",label:"Publish",class:"q-ma-md",size:"large",onClick:t[7]||(t[7]=e=>g.confirm_publish=!0)},{default:(0,o.w5)((()=>[g.loading?((0,o.wg)(),(0,o.j4)(v,{key:0,color:"white",size:"1.2em"})):(0,o.kq)("",!0)])),_:1})]),(0,o.Wm)(C,{modelValue:g.clear_cover,"onUpdate:modelValue":t[8]||(t[8]=e=>g.clear_cover=e),ref:"clearCoverDialog"},{default:(0,o.w5)((()=>[(0,o.Wm)(P,null,{default:(0,o.w5)((()=>[(0,o.Wm)(k,{class:"row items-center"},{default:(0,o.w5)((()=>[(0,o._)("span",p,"Are you sure you want delete? Image of "+(0,i.zw)(g.coverToBeCleared.replace("_"," ").toUpperCase())+" will be cleared",1)])),_:1}),(0,o.Wm)($,{align:"right"},{default:(0,o.w5)((()=>[(0,o.wy)((0,o.Wm)(y,{flat:"",label:"Cancel",color:"primary"},null,512),[[U]]),(0,o.Wm)(y,{flat:"",icon:"delete",label:"Delete",color:"negative",onClick:m.clearCover},null,8,["onClick"])])),_:1})])),_:1})])),_:1},8,["modelValue"]),(0,o.Wm)(C,{modelValue:g.confirm_untick,"onUpdate:modelValue":t[9]||(t[9]=e=>g.confirm_untick=e),persistent:"",ref:"deleteDialog"},{default:(0,o.w5)((()=>[(0,o.Wm)(P,null,{default:(0,o.w5)((()=>[(0,o.Wm)(k,{class:"row items-center"},{default:(0,o.w5)((()=>[(0,o._)("span",d,"Are you sure you want delete? All related and children data of the "+(0,i.zw)(g.difference_option_label)+" will be lost",1)])),_:1}),(0,o.Wm)($,{align:"right"},{default:(0,o.w5)((()=>[(0,o.Wm)(y,{flat:"",label:"Cancel",color:"primary",onClick:m.cancelDelete},null,8,["onClick"]),(0,o.Wm)(y,{flat:"",icon:"delete",label:"Delete",color:"negative",onClick:m.confirmDelete},null,8,["onClick"])])),_:1})])),_:1})])),_:1},8,["modelValue"]),(0,o.Wm)(C,{modelValue:g.confirm_publish,"onUpdate:modelValue":t[10]||(t[10]=e=>g.confirm_publish=e),persistent:"",ref:"publishDialog"},{default:(0,o.w5)((()=>[(0,o.Wm)(P,null,{default:(0,o.w5)((()=>[(0,o.Wm)(k,{class:"row items-center"},{default:(0,o.w5)((()=>[h])),_:1}),(0,o.Wm)($,{align:"right"},{default:(0,o.w5)((()=>[(0,o.wy)((0,o.Wm)(y,{flat:"",label:"Cancel",color:"primary"},null,512),[[U]]),(0,o.Wm)(y,{flat:"",icon:"publish",label:"Publish",color:"positive",onClick:m.confirmPublish},null,8,["onClick"])])),_:1})])),_:1})])),_:1},8,["modelValue"])])])),_:1})}const g={class:"ellipsis relative-position"};function m(e,t,r,s,a,n){const l=(0,o.up)("q-linear-progress"),c=(0,o.up)("q-icon"),p=(0,o.up)("q-avatar"),d=(0,o.up)("q-tooltip"),h=(0,o.up)("q-chip"),u=(0,o.up)("q-btn"),m=(0,o.up)("q-file");return(0,o.wg)(),(0,o.j4)(m,{value:a.files,onInput:n.updateFiles,label:e.$props.label,outlined:"",multiple:"",append:e.$props.multiple,accept:".jpg, .png, .gif, image/*","max-file-size":"10000000",onRejected:n.onRejected,clearable:!n.isUploading,style:{"max-width":"300px"}},(0,o.Nv)({file:(0,o.w5)((({index:e,file:t})=>[(0,o.Wm)(h,{class:"full-width q-my-xs bg-grey",removable:n.isUploading&&a.uploadProgress[e].percent<1,square:"",onRemove:t=>n.cancelFile(e)},{default:(0,o.w5)((()=>[(0,o.Wm)(l,{class:"absolute-full full-height",value:a.uploadProgress[e].percent,color:a.uploadProgress[e].color,"track-color":"grey-2"},null,8,["value","color"]),(0,o.Wm)(p,null,{default:(0,o.w5)((()=>[(0,o.Wm)(c,{name:a.uploadProgress[e].icon},null,8,["name"])])),_:2},1024),(0,o._)("div",g,(0,i.zw)(t.name),1),(0,o.Wm)(d,null,{default:(0,o.w5)((()=>[(0,o.Uk)((0,i.zw)(t.name),1)])),_:2},1024)])),_:2},1032,["removable","onRemove"])])),_:2},[n.canUpload?{name:"after",fn:(0,o.w5)((()=>[(0,o.Wm)(u,{color:"primary",dense:"",icon:"cloud_upload",round:"",onClick:n.upload,disable:!n.canUpload,loading:n.isUploading},null,8,["onClick","disable","loading"])]))}:void 0]),1032,["value","onInput","label","append","onRejected","clearable"])}var f=r(515),_=r.n(f);const w={name:"FileUploader",props:{label:{type:String,default:"Pick Files"},multiple:{type:Boolean,default:!1}},data(){return{files:null,uploadProgress:[],uploading:null,error:!1,percent:0}},computed:{isUploading(){return null!==this.uploading},canUpload(){return null!==this.files}},methods:{onRejected(e){for(let t=0;t<e.length;t++){const r=e[t];this.$q.notify({type:"negative",message:`${r.file.name} was rejected as it fails ${r.failedPropValidation.replaceAll("-"," ")} validation`})}},cancelFile(e){this.uploadProgress[e]=_()(_()({},this.uploadProgress[e]),{},{error:!0,color:"orange-2"})},updateFiles(e){this.files=e,this.uploadProgress=(e||[]).map((e=>({error:!1,color:"green-2",percent:0,icon:0===e.type.indexOf("video/")?"movie":0===e.type.indexOf("image/")?"photo":0===e.type.indexOf("audio/")?"audiotrack":"insert_drive_file"})))},upload(){clearTimeout(this.uploading);let e={files:this.files,type:this.$props.label};this.$emit("upload",e,(e=>{e?this.percent=1:this.error=!0}));const t=this.uploadProgress.every((e=>1===e.percent));this.uploadProgress=this.uploadProgress.map((e=>_()(_()({},e),{},{error:!1,color:"green-2",percent:!0===t?0:e.percent}))),this.__updateUploadProgress()},__updateUploadProgress(){let e=!0;this.uploadProgress=this.uploadProgress.map((t=>{if(t.percent=this.percent,1===t.percent||!0===t.error)return t;const r=Math.min(1,t.percent+Math.random()/10),o=this.error;return!1===o&&r<1&&!0===e&&(e=!1),this.percent=r,_()(_()({},t),{},{error:o,color:!0===o?"red-2":"green-2",percent:r})})),this.uploading=!0!==e?setTimeout(this.__updateUploadProgress,300):null}},beforeUnmount(){clearTimeout(this.uploading)}};var y=r(1052),b=r(7030),v=r(1598),k=r(5096),$=r(4554),P=r(8870),C=r(8240),q=r(7518),U=r.n(q);w.render=m;const W=w;U()(w,"components",{QFile:y.Z,QChip:b.Z,QLinearProgress:v.Z,QAvatar:k.Z,QIcon:$.Z,QTooltip:P.Z,QBtn:C.Z});const B={name:"ManuscriptPage",components:{FileUploader:W},data(){return{title:this.$store.getters["write/manuscriptProperty"]("title"),description:this.$store.getters["write/manuscriptProperty"]("description"),frontCover:this.$store.getters["write/manuscriptProperty"]("front_cover"),backCover:this.$store.getters["write/manuscriptProperty"]("back_cover"),options:[{label:"Contain Characters",body:"contain_character"},{label:"Contain Front Matter",body:"contain_front_matter"},{label:"Contain Chapters",body:"contain_chapter"},{label:"Contain Back Matter",body:"contain_back_matter"},{label:"Automatically add titles as h2 tags",body:"auto_add_title"}],configs:this.$store.getters["write/manuscriptProperty"]("configs"),ticked:this.$store.getters["write/getConfigs"],selectedOptions:this.$store.getters["write/getConfigs"],loading:!1,difference_option:"",difference_option_label:"",confirm_untick:!1,confirm_publish:!1,clear_cover:!1,coverToBeCleared:""}},methods:{editTitle(e=!1){!e&&this.$store.getters["write/isLoading"]||this.$store.dispatch("write/editManuscript",{title:this.title}).then((e=>{})).catch((e=>{console.log(e),this.$q.notify({color:"negative",position:"top",message:e.response.data.message||"Something went wrong",icon:"error"})}))},editDescription(e=!1){!e&&this.$store.getters["write/isLoading"]||this.$store.dispatch("write/editManuscript",{description:this.description}).then((e=>{})).catch((e=>{this.$q.notify({color:"negative",position:"top",message:e.response.data.message||"Something went wrong",icon:"error"})}))},clearCover(){if(!this.$store.getters["write/isLoading"]){const e={};e[this.coverToBeCleared]="",this.$store.dispatch("write/editManuscript",e).then((e=>{})).catch((e=>{this.$q.notify({color:"negative",position:"top",message:e.response.data.message||"Something went wrong",icon:"error"})})),this.clear_cover=!1}},handleTicked(e){let t=this.selectedOptions.filter((e=>!this.ticked.includes(e)));0!=t.length&&(this.difference_option=t[0],this.difference_option_label=this.$refs.optionsTree.getNodeByKey(this.difference_option)["label"],this.confirm_untick=!0);let r=this.ticked.filter((e=>!this.selectedOptions.includes(e)));if(0!=r.length){this.selectedOptions.push(e);const e=r[0];this.configs[e]=!0,this.$store.dispatch("write/editConfigs",this.configs).then((e=>{})).catch((e=>{this.$q.notify({color:"negative",position:"top",message:e.response.data.message||"Something went wrong",icon:"error"})}))}},handleUpload(e,t){let r=new FormData,o=e.files[0],i=e.type,s=i.toLowerCase().replaceAll(" ","_"),a=`BookKay/${i}/${s}_${this.$store.getters["write/manuscriptProperty"]("id")}`;r.append("file",o,a),this.$store.dispatch("write/uploadMedia",r).then((e=>{let r=e.data.secure_url;t(!0);let o={};o[s]=r,this.$store.dispatch("write/editManuscript",o).then((e=>{})).catch((e=>{this.$q.notify({color:"negative",position:"top",message:e.response.data.message||"Something went wrong",icon:"error"})}))})).catch((e=>{t(!1);var r="";try{r=e.response.data.message}catch(o){r="Something went wrong. Please try refreshing the page"}this.$q.notify({color:"negative",position:"top",message:r,icon:"error"})}))},confirmDelete(){const e=this.selectedOptions.indexOf(this.difference_option);e>-1&&this.selectedOptions.splice(e,1),this.confirm_untick=!1;const t=this.difference_option;this.configs[t]=!1,this.$store.dispatch("write/editConfigs",this.configs).then((r=>{let o="";switch(t){case"contain_character":o="characters";break;case"contain_chapter":o="chapters";break;case"contain_front_matter":o="front_matters";break;case"contain_back_matter":o="back_matters";break;default:}const i=this.$store.getters["write/manuscriptProperty"](o);if(""!=o)for(var s=0;s<i.length;s++){const t=i[s],r={id:t.id,type:o.slice(0,-1)};this.$store.dispatch("write/deleteChapter",r).then((e=>{})).catch((t=>{this.$q.notify({color:"negative",position:"top",message:t.response.data.message||"Something went wrong",icon:"error"}),this.chapters.splice(e,0,chapter)}))}})).catch((e=>{this.$q.notify({color:"negative",position:"top",message:e.response.data.message||"Something went wrong",icon:"error"})}))},cancelDelete(){this.ticked.push(this.difference_option),this.confirm_untick=!1},confirmPublish(){let e=[];if(this.$store.getters["write/manuscriptProperty"]("title")||e.push("title"),this.$store.getters["write/manuscriptProperty"]("description")||e.push("description"),this.$store.getters["write/manuscriptProperty"]("front_cover")||e.push("front_cover"),this.$store.getters["write/manuscriptProperty"]("back_cover")||e.push("back_cover"),this.$store.getters["write/manuscriptProperty"]("title")&&this.$store.getters["write/manuscriptProperty"]("description")&&this.$store.getters["write/manuscriptProperty"]("front_cover")&&this.$store.getters["write/manuscriptProperty"]("back_cover"))this.loading=!0,this.publish();else{let t="Please fill in these information to publish - "+e.toString();this.$q.notify({type:"negative",message:t})}this.confirm_publish=!1},publish(){let e={title:this.$store.getters["write/manuscriptProperty"]("title"),description:this.$store.getters["write/manuscriptProperty"]("description"),front_cover:this.$store.getters["write/manuscriptProperty"]("front_cover"),back_cover:this.$store.getters["write/manuscriptProperty"]("back_cover"),author_id:this.$store.getters["write/manuscriptProperty"]("author").id,price:0,text:this.$store.getters["write/manuscriptProperty"]("text"),publish_date:(new Date).toISOString,contain_character:this.$store.getters["write/manuscriptProperty"]("configs").contain_character,contain_front_matter:this.$store.getters["write/manuscriptProperty"]("configs").contain_front_matter,contain_chapter:this.$store.getters["write/manuscriptProperty"]("configs").contain_chapter,contain_back_matter:this.$store.getters["write/manuscriptProperty"]("configs").contain_back_matter,auto_add_title:this.$store.getters["write/manuscriptProperty"]("configs").auto_add_title};this.$store.dispatch("write/publishBook",e).then((e=>{console.log("data",e);e.data.book.id;this.loading=!1,this.$q.notify({color:"positive",position:"top",message:"Yay! Your book has been published successfully on our bookstore",icon:"error"}),this.$router.push({name:"app-read"})})).catch((e=>{console.log(e);var t="";try{t=e.response.data.message}catch(r){t="Something went wrong. Please try refreshing the page"}this.$q.notify({color:"negative",position:"top",message:t,icon:"error"}),this.loading=!1}))},assembleBook(e){if(this.$store.getters["write/manuscriptProperty"]("configs").contain_character){let r=this.$store.getters["write/manuscriptProperty"]("characters");for(var t=0;t<r.length;t++){let o=r[t];o.book_id=e,this.postChapter(o,"characters")}}if(this.$store.getters["write/manuscriptProperty"]("configs").contain_front_matter){let r=this.$store.getters["write/manuscriptProperty"]("front_matters");for(t=0;t<r.length;t++){let o=r[t];o.book_id=e,this.postChapter(o,"Front Matter")}}if(this.$store.getters["write/manuscriptProperty"]("configs").contain_chapter){let r=this.$store.getters["write/manuscriptProperty"]("chapters");for(t=0;t<r.length;t++){let o=r[t];o.book_id=e,this.postChapter(o,"Chapter")}}if(this.$store.getters["write/manuscriptProperty"]("configs").contain_back_matter){let r=this.$store.getters["write/manuscriptProperty"]("back_matters");for(t=0;t<r.length;t++){let o=r[t];o.book_id=e,this.postChapter(o,"Back Matter")}}},postChapter(e,t){const r={chapter:e,type:t,isBook:!0};this.$store.dispatch("write/addChapter",r).then((e=>{})).catch((e=>{this.$q.notify({color:"negative",position:"top",message:e.response.data.message||"Something went wrong",icon:"error"})}))},onRejected(e){this.$q.notify({type:"negative",message:`${e.length} file(s) did not pass validation constraints`})}}};var T=r(4379),Q=r(5869),Z=r(4689),S=r(6414),V=r(3282),D=r(6778),j=r(151),x=r(5589),F=r(9367),M=r(677);B.render=u;const O=B;U()(B,"components",{QPage:T.Z,QSeparator:Q.Z,QInput:Z.Z,QBtn:C.Z,QTree:S.Z,QSpinnerHourglass:V.Z,QDialog:D.Z,QCard:j.Z,QCardSection:x.Z,QCardActions:F.Z}),U()(B,"directives",{ClosePopup:M.Z})}}]);