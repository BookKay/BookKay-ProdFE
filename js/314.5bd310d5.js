"use strict";(self["webpackChunkbookkay"]=self["webpackChunkbookkay"]||[]).push([[314],{6680:(t,e,a)=>{a.r(e),a.d(e,{default:()=>M});var i=a(3673);function n(t,e,a,n,r,o){const s=(0,i.up)("q-ajax-bar"),l=(0,i.up)("q-btn"),d=(0,i.up)("q-header"),c=(0,i.up)("the-manuscript-side-bar"),p=(0,i.up)("q-drawer"),h=(0,i.up)("router-view"),u=(0,i.up)("q-page-container"),m=(0,i.up)("the-bottom-nav"),g=(0,i.up)("q-footer"),f=(0,i.up)("q-layout");return(0,i.wg)(),(0,i.j4)(f,{view:"lhh LpR lFf"},{default:(0,i.w5)((()=>[(0,i.Wm)(s,{ref:"bar",position:"top",color:"primary",size:"5px"},null,512),(0,i.Wm)(d,{class:"bg-white text-black"},{default:(0,i.w5)((()=>[(0,i.Wm)(l,{flat:"",round:"",icon:"menu",class:"q-ml-md q-mt-sm",onClick:e[0]||(e[0]=t=>r.left=!r.left),ripple:{early:!0}})])),_:1}),(0,i.Wm)(p,{modelValue:r.left,"onUpdate:modelValue":e[1]||(e[1]=t=>r.left=t),"show-if-above":"",side:"left",bordered:"",width:t.$q.screen.lt.md?225:300,overlay:t.$q.screen.lt.sm,behavior:t.$q.screen.lt.sm?"mobile":"desktop"},{default:(0,i.w5)((()=>[(0,i.Wm)(c,{isReady:r.loaded},null,8,["isReady"])])),_:1},8,["modelValue","width","overlay","behavior"]),(0,i.Wm)(u,{style:{"overflow-x":"hidden"}},{default:(0,i.w5)((()=>[(0,i.Wm)(h)])),_:1}),(0,i.Wm)(g,null,{default:(0,i.w5)((()=>[(0,i.Wm)(m)])),_:1})])),_:1})}var r=a(9242);function o(t,e,a,n,r,o){const s=(0,i.up)("side-bar-contents"),l=(0,i.up)("app-prompt-dialog"),d=(0,i.up)("app-confirm-dialog");return(0,i.wg)(),(0,i.iD)(i.HY,null,[(0,i.Wm)(s,{contents:r.navigations,onClicked:o.handleClick,onEdited:o.handleEdit,onDeleted:o.handleDelete},null,8,["contents","onClicked","onEdited","onDeleted"]),((0,i.wg)(!0),(0,i.iD)(i.HY,null,(0,i.Ko)(o.promptDialogs,((t,e)=>((0,i.wg)(),(0,i.j4)(l,{key:e,open:t.state,label:t.label,value:t.value,rules:t.rules,onConfirmed:t.confirmHandler},null,8,["open","label","value","rules","onConfirmed"])))),128)),((0,i.wg)(!0),(0,i.iD)(i.HY,null,(0,i.Ko)(o.confirmDialogs,((t,e)=>((0,i.wg)(),(0,i.j4)(d,{key:e,open:t.state,header:t.label,text:t.text,btnLabel:t.btnLabel,btnColor:t.btnColor,onConfirmed:t.confirmHandler},null,8,["open","header","text","btnLabel","btnColor","onConfirmed"])))),128))],64)}a(5363),a(6801),a(71);var s=a(7535),l=a(9420),d=a(3963);const c=[{data:"Overview",caption:""},{data:"Preview",caption:""},{data:[{data:"Chapter-1",caption:"The time has come",to:{name:"write-editor",query:{manuscript_id:"abc"}},active:!1,id:"abc"},{data:"Chapter-2",caption:"The Deed",to:{name:"write-editor",query:{manuscript_id:"edf"}},active:!0,id:"efg"},{data:"Add Chapter",caption:""}],caption:"",name:"Chapters"}],p={name:"TheManuscriptSideBar",components:{SideBarContents:s.Z,AppPromptDialog:l.Z,AppConfirmDialog:d.Z},props:{isReady:{type:Boolean,default:!1}},data(){return{navigations:[],frontMatterDialog:!1,chapterDialog:!1,backMatterDialog:!1,deleteDialog:!1,componentToDelete:{},deleteType:"",editDialog:!1,componentToEdit:{}}},computed:{promptDialogs(){return[{label:"Add Front Matter",state:this.frontMatterDialog,value:"New Front Matter Title",rules:[t=>null!==t&&""!==t||"Please type your title",t=>t.length<=100||"Front Matter title must be smaller than 100"],confirmHandler:this.addFrontMatter},{label:"Add Chapter Matter",state:this.chapterDialog,value:"New Chapter Title",rules:[t=>null!==t&&""!==t||"Please type your title",t=>t.length<=100||"Chapter title must be smaller than 100"],confirmHandler:this.addChapter},{label:"Add Back Matter",state:this.backMatterDialog,value:"New Back Matter Title",rules:[t=>null!==t&&""!==t||"Please type your title",t=>t.length<=100||"Back Matter title must be smaller than 100"],confirmHandler:this.addBackMatter},{label:"Title",state:this.editDialog,value:this.componentToEdit.caption,rules:[t=>null!==t&&""!==t||"Please type your title",t=>t.length<=100||"Title must be smaller than 100"],confirmHandler:this.editComponent}]},confirmDialogs(){return[{label:`Delete ${this.deleteType}`,state:this.deleteDialog,text:`Are you sure you want to delete this ${this.deleteType}?`,btnLabel:"Delete",btnColor:"negative",confirmHandler:this.deleteComponent}]}},watch:{$route:{handler:function(t){this.syncActive(t)},deep:!0},"$props.isReady":{handler:function(t){t&&(this.navigations=this.initNavigations(this.$store.state.write.manuscript),this.syncActive(this.$route))}},"$store.state.write.manuscript":{handler:function(t){this.navigations=this.initNavigations(this.$store.state.write.manuscript),this.syncActive(t)},deep:!0}},mounted(){this.$props.isReady&&(this.navigations=this.initNavigations(this.$store.state.write.manuscript),this.syncActive(this.$route))},methods:{async handleClick(t){if(t.to)await this.$router.push(t.to);else switch(t.data){case"Add Front Matter":this.frontMatterDialog=!0;break;case"Add Chapter":this.chapterDialog=!0;break;case"Add Back Matter":this.backMatterDialog=!0;break;default:}},handleDelete(t){t.data.startsWith("Front Matter")?this.deleteType="Front Matter":t.data.startsWith("Chapter")?this.deleteType="Chapter":t.data.startsWith("Back Matter")&&(this.deleteType="Back Matter"),this.componentToDelete=t,this.deleteDialog=!0},async deleteComponent(t){if(this.deleteDialog=!1,t){let t=this.componentToDelete.data.split("-")[0];t=t.toLowerCase().trim().replace(" ","-");let e={id:this.componentToDelete.id,type:t};try{await this.$store.dispatch("write/deleteComponent",e),this.navigations=this.initNavigations(this.$store.state.write.manuscript),this.syncActive(this.$route),this.componentToDelete.active&&this.$router.replace({name:"write-overview",params:{manuscript_id:this.$store.getters["write/manuscriptProperty"]("id")}})}catch{this.$q.notify({color:"negative",position:"top",message:"Delete unsuccessful",icon:"error"})}}},handleEdit(t){this.componentToEdit=t,this.editDialog=!0},async editComponent(t){if(this.editDialog=!1,t){let e=this.componentToEdit.data.split("-")[0];e=e.toLowerCase().trim().replace(" ","-");let a={component:{title:t},id:this.componentToEdit.id,type:e};try{await this.$store.dispatch("write/editComponent",a),this.navigations=this.initNavigations(this.$store.state.write.manuscript),this.syncActive(this.$route)}catch{this.$q.notify({color:"negative",position:"top",message:"Edit unsuccessful",icon:"error"})}}},initNavigations(t){let e=this,a=[{data:"Overview",caption:"",to:{name:"write-overview",params:{manuscript_id:t.id}},active:!1},{data:"Preview",caption:"",to:{name:"read-book",query:{manuscript_id:t.id}},active:!1}];if(t.configs.contain_front_matter){let t=i("front_matters","Front Matter");a.push(t)}if(t.configs.contain_chapter){let t=i("chapters","Chapter");a.push(t)}else{let e={data:"Main Text",caption:t.title,to:{name:"write-editor",query:{manuscript_id:t.id}},active:!1};a.push(e)}if(t.configs.contain_back_matter){let t=i("back_matters","Back Matter");a.push(t)}return a;function i(a,i){let n=[...t[a]];n=n.sort(e.compareIndex);let r=[];for(let t=0;t<n.length;t++){let e,o=n[t];e=`${i} - ${t+1}`;let s={data:e,caption:o.title,to:{name:"write-editor",query:{}},id:o.id,delete:!0,edit:!0,active:!1},l=a.lastIndexOf("s"),d=a.substring(0,l);s.to.query[`${d}_id`]=o.id,r.push(s)}r.push({data:`Add ${i}`,caption:""});let o={data:r,caption:"",name:`${i}s`};return o}},compareIndex(t,e){return t.index<e.index?-1:t.index>e.index?1:0},getCurrentNav(t){for(let e=0;e<t.length;e++){let a=t[e];if(a.active)return a;if("string"!=typeof a.data&&this.getCurrentNav(a.data))return this.getCurrentNav(a.data)}},syncActive(t){let e=this.getCurrentNav(this.navigations);e&&(e.active=!1);const a=t.name;if("write-overview"==a){let t=this.navigations.find((t=>"Overview"==t.data));t.active=!0}else if("write-editor"==a){let e,a,i=Object.keys(t.query)[0],n=t.query[i];switch(i){case"manuscript_id":let t=this.navigations.find((t=>"Main Text"==t.data));t.active=!0;break;case"front_matter_id":e=this.navigations.find((t=>"Front Matters"==t.name)),a=e.data.find((t=>t.id==n)),a.active=!0;break;case"chapter_id":e=this.navigations.find((t=>"Chapters"==t.name)),a=e.data.find((t=>t.id==n)),a.active=!0;break;case"back_matter_id":e=this.navigations.find((t=>"Back Matters"==t.name)),a=e.data.find((t=>t.id==n)),a.active=!0;break}}},addFrontMatter(t){this.frontMatterDialog=!1,t&&this.addComponent(t,"Front Matter")},addChapter(t){this.chapterDialog=!1,t&&this.addComponent(t,"Chapter")},addBackMatter(t){this.backMatterDialog=!1,t&&this.addComponent(t,"Back Matter")},async addComponent(t,e){let a={time:1634195030352,blocks:[{id:"mEx28VKFcm",type:"heading",data:{text:t,level:3},tunes:{alignment:{alignment:"center"}}}],version:"2.22.2"};const i={component:{title:t,text:a,index:this.$store.getters["write/manuscriptProperty"](e.toLowerCase().replace(" ","_")+"s").length,component_owner_id:this.$store.getters["write/manuscriptProperty"]("component_owner_id")},type:e};await this.$store.dispatch("write/addComponent",i),this.$props.isReady&&(this.navigations=this.initNavigations(this.$store.state.write.manuscript),this.syncActive(this.$route))}}};var h=a(4260);const u=(0,h.Z)(p,[["render",o]]),m=u,g={components:{TheBottomNav:r.Z,TheManuscriptSideBar:m},async mounted(){if(this.$route.params.manuscript_id)await this.initManuscript(this.$route.params.manuscript_id),this.loaded=!0;else if(this.$route.query.manuscript_id)await this.initManuscript(this.$route.query.manuscript_id),this.loaded=!0;else if("front_matter_id"in this.$route.query){let t,e=this.$route.query.front_matter_id;t=await this.$api.get(`front-matters/${e}/manuscript_id`),await this.initManuscript(t.data),this.loaded=!0}else if("chapter_id"in this.$route.query){let t,e=this.$route.query.chapter_id;t=await this.$api.get(`chapters/${e}/manuscript_id`),await this.initManuscript(t.data),this.loaded=!0}else if("back_matter_id"in this.$route.query){let t,e=this.$route.query.back_matter_id;t=await this.$api.get(`back-matters/${e}/manuscript_id`),await this.initManuscript(t.data),this.loaded=!0}},data(){return{left:!1,tab:"write",navigations:c,navigationsA:[{label:"Configs",name:"write-config"},{label:"Book",name:"write-overview",children:[]}],loaded:!1,selected:"",currentSelected:""}},methods:{async initManuscript(t){let e;e=await this.$api.get("manuscripts/"+t);let a=e.data;await this.$api.post(`manuscripts/${t}/edited`),e=await this.$api.get("default-book-prototypes/"+e.data.prototype_id,{params:{expand:"~all"}});let i=e.data;for(const r in i)r in a?a[`prototype_${r}`]=i[r]:a[r]=i[r];this.$store.commit("write/setManuscript",a);try{this.$q.sessionStorage.set("currentManuscript",a)}catch(n){console.log("err",n)}},compareIndex(t,e){return t.index<e.index?-1:t.index>e.index?1:0}}};var f=a(3066),v=a(614),w=a(3812),y=a(8240),b=a(6873),$=a(2652),C=a(1762),k=a(7518),_=a.n(k);const D=(0,h.Z)(g,[["render",n]]),M=D;_()(g,"components",{QLayout:f.Z,QAjaxBar:v.Z,QHeader:w.Z,QBtn:y.Z,QDrawer:b.Z,QPageContainer:$.Z,QFooter:C.Z})}}]);